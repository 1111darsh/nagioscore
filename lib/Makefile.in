CC = gcc
COV_CFLAGS = -O0 -ftest-coverage -fprofile-arcs -pg
LDFLAGS =
CFLAGS = -Wall @CFLAGS@ @DEFS@
ALL_CFLAGS = $(CFLAGS)
LIBNAME = libnagios.a

all: $(LIBNAME)

SNPRINTF_O=@SNPRINTF_O@
TESTED_SRC_C := squeue.c kvvec.c iocache.c iobroker.c
SRC_C := $(TESTED_SRC_C) pqueue.c
SRC_O := $(patsubst %.c,%.o,$(SRC_C)) $(SNPRINTF_O)
TESTS := $(patsubst %.c,test-%,$(TESTED_SRC_C))

test: $(TESTS)
	@for t in $(TESTS); do echo $$t:; ./$$t; echo; done

test-squeue: pqueue.o test-squeue.o
	$(CC) $^ -o $@

%.o: %.c %.h Makefile
	$(CC) $(ALL_CFLAGS) -c $< -o $@

$(LIBNAME): $(SRC_O)
	$(AR) cr $@ $^

wproc: wproc.o $(LIBNAME)
	$(CC) $(ALL_CFLAGS) $(ALL_LDFLAGS) $^ -o $@

distclean: clean
	rm -f Makefile

clean: clean-test
	rm -f core.* *.o *~ wproc *.gcov *.gcda *.gcno gmon.out *.a

clean-test:
	rm -f $(TESTS)

.PHONY: clean clean-test coverage
